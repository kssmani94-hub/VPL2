{% extends "base.html" %}
{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<div class="admin-container" style="width: 98%; margin: 20px auto; padding: 10px; font-family: 'Segoe UI', sans-serif;">
    
    {% set total_slots = 200 %} 
    {% set current_regs = players|length %}
    {% set remaining = total_slots - current_regs %}

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: #003554; color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 20px rgba(0,53,84,0.2);">
            <p style="margin:0; font-size: 0.8rem; opacity: 0.8; text-transform: uppercase; font-weight: 700;">Total Registrations</p>
            <p style="margin:5px 0 0; font-size: 2.2rem; font-weight: 800;">{{ current_regs }} / {{ total_slots }}</p>
        </div>
        
        <div style="background: #ffffff; border: 1px solid #ddd; padding: 25px; border-radius: 15px; text-align: center;">
            <p style="margin:0; font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700;">Awaiting Approval</p>
            <p style="margin:5px 0 0; font-size: 2.2rem; font-weight: 800; color: #f39c12;">
                {{ players | selectattr('status', 'in', ['Awaiting Approval', 'Pending Approval']) | list | length }}
            </p>
        </div>

        <div style="background: #eef6ff; border: 2px solid #00a6fb; padding: 25px; border-radius: 15px; text-align: center;">
            <p style="margin:0; font-size: 0.8rem; color: #003554; text-transform: uppercase; font-weight: 700;">Slots Remaining</p>
            <p style="margin:5px 0 0; font-size: 2.2rem; font-weight: 800; color: #00a6fb;">{{ remaining if remaining > 0 else 0 }}</p>
        </div>
    </div>

    <div style="background: #fff; padding: 20px 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <div style="position: relative;">
                    <i class="fa fa-search" style="position: absolute; left: 15px; top: 12px; color: #94a3b8;"></i>
                    <input type="text" id="adminSearch" onkeyup="applyAllFilters()" placeholder="Search Name, ID..." 
                           style="width: 250px; padding: 10px 10px 10px 40px; border-radius: 8px; border: 1px solid #e2e8f0; outline: none;">
                </div>

                <select id="statusFilter" onchange="applyAllFilters()" style="padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; color: #475569; font-weight: 600; cursor: pointer;">
                    <option value="">All Statuses</option>
                    <option value="Approved">Approved</option>
                    <option value="Awaiting Approval">Awaiting Approval</option>
                    <option value="Pending Approval">Pending Approval</option>
                </select>

                <select id="roleFilter" onchange="applyAllFilters()" style="padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; color: #475569; font-weight: 600; cursor: pointer;">
                    <option value="">All Roles</option>
                    <option value="Batsman">Batsman</option>
                    <option value="Bowler">Bowler</option>
                    <option value="All-Rounder">All-Rounder</option>
                    <option value="Wicket-Keeper">Wicket-Keeper</option>
                </select>
            </div>

            <div style="display: flex; gap: 15px;">
                <button onclick="exportToExcel()" style="background: #22c55e; color: white; padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <i class="fa fa-file-excel"></i> DOWNLOAD EXCEL
                </button>

                {% if session.get('user_role') in ['admin', 'super_admin'] %}
                <a href="{{ url_for('import_stats') }}" style="background: #00a6fb; color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fa fa-file-import"></i> IMPORT STATS
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div style="background: #fff; border-radius: 15px; box-shadow: 0 5px 30px rgba(0,0,0,0.05); overflow-x: auto;">
        <table id="vplTable" style="width: 100%; border-collapse: collapse; min-width: 1100px;">
            <thead>
                <tr style="background: #003554; color: white;">
                    <th onclick="sortTable(0)" style="width: 10%; padding: 18px; text-align: left; cursor: pointer; user-select: none;">
                        VPL ID <i class="fa fa-sort" style="opacity: 0.5;"></i>
                    </th>
                    
                    <th onclick="sortTable(1)" style="width: 25%; padding: 18px; text-align: left; cursor: pointer; user-select: none;">
                        Full Name <i class="fa fa-sort" style="opacity: 0.5;"></i>
                    </th>
                    
                    <th style="width: 15%; padding: 18px; text-align: center;">Mobile</th>
                    
                    <th style="width: 15%; padding: 18px; text-align: center;">Status</th>
                    
                    <th style="width: 20%; padding: 18px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in players %}
                <tr class="player-row" data-status="{{ p.status }}" data-role="{{ p.role }}" style="border-bottom: 1px solid #f1f5f9; transition: 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                    
                    <td style="padding: 15px 18px; font-weight: 800; color: #00a6fb; text-align: left;">{{ p.vpl_id }}</td>
                    
                    <td style="padding: 15px 18px; font-weight: 600; color: #334155; text-align: left;">{{ p.full_name }}</td>
                    
                    <td style="padding: 15px 18px; text-align: center; color: #64748b;">{{ p.phone }}</td>
                    
                    <td style="padding: 15px 18px; text-align: center;">
                        <span class="status-badge" style="padding: 6px 15px; border-radius: 50px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; display: inline-block; min-width: 100px;
                            background: {% if p.status == 'Approved' %}#dcfce7; color: #15803d;{% elif p.status in ['Awaiting Approval', 'Pending Approval'] %}#fef9c3; color: #a16207;{% else %}#fee2e2; color: #b91c1c;{% endif %}">
                            {{ p.status }}
                        </span>
                    </td>
                    
                    <td style="padding: 15px 18px; text-align: center;">
                        <div style="display: flex; justify-content: center; gap: 8px; align-items: center;">
                            <button onclick="toggleRow('{{ p.id }}')" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; color: #475569; font-size: 0.75rem;">VIEW</button>
                            
                            {% if session.get('user_role') in ['admin', 'super_admin'] %}
                            <a href="{{ url_for('edit_player', id=p.id) }}" style="background: #003554; color: white; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-weight: 700; font-size: 0.75rem;">EDIT</a>
                            <form action="{{ url_for('delete_player', id=p.id) }}" method="POST" onsubmit="return confirm('DELETE {{ p.full_name }}?');" style="display:inline; margin:0;">
                                <button type="submit" style="background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>

                <tr id="profile-{{ p.id }}" style="display: none; background: #fafafa; border-bottom: 3px solid #00a6fb;">
                    <td colspan="5" style="padding: 30px;">
                        <div style="display: flex; gap: 40px; align-items: start; flex-wrap: wrap;">
                            <div style="display: flex; gap: 20px;">
                                <div style="text-align: center;">
                                    <label style="display:block; font-size: 0.6rem; font-weight: 900; color: #003554; margin-bottom: 5px; text-transform: uppercase;">Photo</label>
                                    <img src="{{ url_for('static', filename='uploads/' + p.photo) }}" style="width: 140px; height: 180px; object-fit: cover; border-radius: 12px; border: 3px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                                </div>
                                <div style="text-align: center;">
                                    <label style="display:block; font-size: 0.6rem; font-weight: 900; color: #003554; margin-bottom: 5px; text-transform: uppercase;">Payment Proof</label>
                                    {% if p.payment_screenshot %}
                                        <a href="{{ url_for('static', filename='uploads/' + p.payment_screenshot) }}" target="_blank">
                                            <img src="{{ url_for('static', filename='uploads/' + p.payment_screenshot) }}" style="width: 140px; height: 180px; object-fit: cover; border-radius: 12px; border: 3px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                                        </a>
                                    {% else %}
                                        <div style="width: 140px; height: 180px; background: #e2e8f0; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 0.7rem; font-weight: bold; border: 2px dashed #cbd5e1;">N/A</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div style="flex: 1; min-width: 300px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase; display:block;">Age</label><div style="font-weight: 700;">{{ p.age }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase; display:block;">CricHeroes Name</label><div style="font-weight: 700;">{{ p.ch_name }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase; display:block;">Role</label><div style="font-weight: 700;">{{ p.role }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase; display:block;">Style</label><div style="font-weight: 700;">{{ p.style }}</div></div>
                                    <div class="field"><label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase; display:block;">Regular Team</label><div style="font-weight: 700;">{{ p.current_team }}</div></div>
                                    
                                    <div class="field" style="background:#eef6ff; padding:8px; border-radius:8px;"><label style="font-size: 0.65rem; color: #003554; font-weight: 900; text-transform: uppercase; display:block;">Jersey Name</label><div style="font-weight: 800; color:#003554;">{{ p.shirt_name }}</div></div>
                                    <div class="field" style="background:#eef6ff; padding:8px; border-radius:8px;"><label style="font-size: 0.65rem; color: #003554; font-weight: 900; text-transform: uppercase; display:block;">Jersey Number</label><div style="font-weight: 800; color:#003554;">#{{ p.shirt_number }}</div></div>
                                    <div class="field" style="background:#eef6ff; padding:8px; border-radius:8px;"><label style="font-size: 0.65rem; color: #003554; font-weight: 900; text-transform: uppercase; display:block;">Size & Sleeves</label><div style="font-weight: 800; color:#003554;">{{ p.shirt_size }} ({{ p.sleeves }})</div></div>
                                    
                                    <div class="field" style="grid-column: 1 / -1; border-top: 1px solid #eee; padding-top: 10px;">
                                        <label style="font-size: 0.65rem; color: #00a6fb; font-weight: 900; text-transform: uppercase; display:block;">Admin Comments</label>
                                        <div style="font-size: 0.85rem; color: #64748b; font-style: italic;">{{ p.comments or 'No notes added.' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // 1. COMBINED FILTER LOGIC
    function applyAllFilters() {
        let searchVal = document.getElementById("adminSearch").value.toUpperCase();
        let statusVal = document.getElementById("statusFilter").value;
        let roleVal = document.getElementById("roleFilter").value;
        let rows = document.querySelectorAll(".player-row");

        rows.forEach(row => {
            let text = row.innerText.toUpperCase();
            let status = row.getAttribute("data-status");
            let role = row.getAttribute("data-role");

            let matchesSearch = text.indexOf(searchVal) > -1;
            let matchesStatus = statusVal === "" || status === statusVal;
            let matchesRole = roleVal === "" || role === roleVal;

            let nextRow = row.nextElementSibling;
            let isProfile = nextRow && nextRow.id.startsWith("profile-");

            if (matchesSearch && matchesStatus && matchesRole) {
                row.style.display = "";
            } else {
                row.style.display = "none";
                if(isProfile) {
                    nextRow.style.display = "none";
                }
            }
        });
    }

    // 2. EXPORT FUNCTION
    function exportToExcel() {
        var table = document.getElementById("vplTable");
        var wb = XLSX.utils.table_to_book(table, {sheet: "VPL Players"});
        XLSX.writeFile(wb, "VPL_Players_List.xlsx");
    }

    // 3. PAIRED SORTING LOGIC
    function sortTable(n) {
        const table = document.getElementById("vplTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr.player-row"));
        const isAscending = table.dataset.sortDir === "asc";
        
        const pairedRows = rows.map(row => ({
            main: row,
            profile: row.nextElementSibling
        }));

        pairedRows.sort((a, b) => {
            let x = a.main.getElementsByTagName("TD")[n].innerText.toLowerCase();
            let y = b.main.getElementsByTagName("TD")[n].innerText.toLowerCase();
            
            if (n === 0) {
                x = parseInt(x.replace(/\D/g, '')) || 0;
                y = parseInt(y.replace(/\D/g, '')) || 0;
            }
            
            if (x < y) return isAscending ? -1 : 1;
            if (x > y) return isAscending ? 1 : -1;
            return 0;
        });

        tbody.innerHTML = "";
        pairedRows.forEach(pair => {
            tbody.appendChild(pair.main);
            if (pair.profile) tbody.appendChild(pair.profile);
        });

        table.dataset.sortDir = isAscending ? "desc" : "asc";
        updateSortIcons(n, isAscending);
    }

    function updateSortIcons(colIndex, isAsc) {
        const icons = document.querySelectorAll("#vplTable th i");
        icons.forEach((icon, idx) => {
            if (idx === colIndex) {
                icon.className = isAsc ? "fa fa-sort-up" : "fa fa-sort-down";
                icon.style.color = "#00a6fb";
            } else {
                icon.className = "fa fa-sort";
                icon.style.color = "white";
            }
        });
    }

    // 4. ROW TOGGLE
    function toggleRow(id) {
        let profileRow = document.getElementById('profile-' + id);
        if (profileRow.style.display === "table-row") {
            profileRow.style.display = "none";
        } else {
            profileRow.style.display = "table-row";
        }
    }
</script>
{% endblock %}